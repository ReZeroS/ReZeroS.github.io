<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="keywords" content="Hexo Theme Redefine"><meta name="author" content="ReZero"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="canonical" href="https://rezeros.github.io/2020/10/01/csapp/"><meta name="robots" content="index,follow"><meta name="googlebot" content="index,follow"><meta name="revisit-after" content="1 days"><meta name="description" content="Before that, think more."><meta property="og:type" content="article"><meta property="og:title" content="CSAPP"><meta property="og:url" content="https://rezeros.github.io/2020/10/01/csapp/index.html"><meta property="og:site_name" content="ReZero"><meta property="og:description" content="Before that, think more."><meta property="og:locale" content="en_US"><meta property="og:image" content="https://rezeros.github.io/images/redefine-og.webp"><meta property="article:published_time" content="2020-10-01T12:41:00.000Z"><meta property="article:modified_time" content="2025-04-15T23:03:26.471Z"><meta property="article:author" content="ReZero"><meta property="article:tag" content="Program"><meta property="article:tag" content="OS"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://rezeros.github.io/images/redefine-og.webp"><link rel="icon" type="image/png" href="/images/redefine-favicon.svg" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/redefine-favicon.svg"><meta name="theme-color" content="#A31F34"><link rel="shortcut icon" href="/images/redefine-favicon.svg"><title>CSAPP | ReZero&#39;s blog</title><link rel="stylesheet" href="/fonts/Chillax/chillax.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/build/tailwind.css"><link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css"><link rel="stylesheet" href="/fonts/Geist/geist.css"><script src="/js/build/libs/anime.min.js"></script><script id="hexo-configurations">window.config={hostname:"rezeros.github.io",root:"/",language:"en",path:"search.xml"},window.theme={articles:{style:{font_size:"16px",line_height:1.5,image_border_radius:"14px",image_alignment:"center",image_caption:!1,link_icon:!0,delete_mask:!1,title_alignment:"left",headings_top_spacing:{h1:"3.2rem",h2:"2.4rem",h3:"1.9rem",h4:"1.6rem",h5:"1.4rem",h6:"1.3rem"}},word_count:{enable:!0,count:!0,min2read:!0},author_label:{enable:!0,auto:!1,list:[]},code_block:{copy:!0,style:"mac",highlight_theme:{light:"github",dark:"vs2015"},font:{enable:!1,family:null,url:null}},toc:{enable:!0,max_depth:3,number:!1,expand:!0,init_open:!0},copyright:{enable:!0,default:"cc_by_nc_sa"},lazyload:!0,pangu_js:!1,recommendation:{enable:!1,title:"推荐阅读",limit:3,mobile_limit:2,placeholder:"/images/wallhaven-wqery6-light.webp",skip_dirs:[]}},colors:{primary:"#A31F34",secondary:null,default_mode:"light"},global:{fonts:{chinese:{enable:!1,family:null,url:null},english:{enable:!1,family:null,url:null},title:{enable:!1,family:null,url:null}},content_max_width:"1000px",sidebar_width:"210px",hover:{shadow:!0,scale:!1},scroll_progress:{bar:!1,percentage:!0},website_counter:{url:"https://cn.vercount.one/js",enable:!0,site_pv:!0,site_uv:!0,post_pv:!0},single_page:!0,preloader:{enable:!0,custom_message:"Advance ruthlessly—whatever the cost!"},open_graph:{enable:!0,image:"/images/redefine-og.webp",description:"Before that, think more."},google_analytics:{enable:!1,id:null}},home_banner:{enable:!0,style:"fixed",image:{light:"/images/wallhaven-wqery6-light.webp",dark:"/images/wallhaven-wqery6-dark.webp"},title:"Before that, think more.",subtitle:{text:[],hitokoto:{enable:!1,show_author:!1,api:"https://v1.hitokoto.cn"},typing_speed:100,backing_speed:80,starting_delay:500,backing_delay:1500,loop:!0,smart_backspace:!0},text_color:{light:"#fff",dark:"#d1d1b6"},text_style:{title_size:"2.8rem",subtitle_size:"1.5rem",line_height:1.2},custom_font:{enable:!1,family:null,url:null},social_links:{enable:!1,style:"default",links:{github:null,instagram:null,zhihu:null,twitter:null,email:null},qrs:{weixin:null}}},plugins:{feed:{enable:!1},aplayer:{enable:!1,type:"fixed",audios:[{name:null,artist:null,url:null,cover:null,lrc:null}]},mermaid:{enable:!1,version:"11.4.1"}},version:"2.8.2",navbar:{auto_hide:!1,color:{left:"#f78736",right:"#367df7",transparency:35},width:{home:"1200px",pages:"1000px"},links:{Home:{path:"/",icon:"fa-regular fa-house"},Categories:{path:"/categories/",icon:"fa-solid fa-folder"},Tags:{path:"/tags/",icon:"fa-solid fa-tags"}},search:{enable:!1,preload:!0}},page_templates:{friends_column:2,tags_style:"blur"},home:{sidebar:{enable:!0,position:"left",first_item:"menu",announcement:null,show_on_mobile:!0,links:null},article_date_format:"auto",excerpt_length:200,categories:{enable:!0,limit:3},tags:{enable:!0,limit:3}},footerStart:"2022/8/17 11:45:14"},window.lang_ago={second:"%s seconds ago",minute:"%s minutes ago",hour:"%s hours ago",day:"%s days ago",week:"%s weeks ago",month:"%s months ago",year:"%s years ago"},window.data={masonry:!1}</script><link rel="stylesheet" href="/fontawesome/fontawesome.min.css"><link rel="stylesheet" href="/fontawesome/brands.min.css"><link rel="stylesheet" href="/fontawesome/solid.min.css"><link rel="stylesheet" href="/fontawesome/regular.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="progress-bar-container"><span class="pjax-progress-bar"></span></div><style>:root{--preloader-background-color:#fff;--preloader-text-color:#000}@media (prefers-color-scheme:dark){:root{--preloader-background-color:#202124;--preloader-text-color:#fff}}@media (prefers-color-scheme:light){:root{--preloader-background-color:#fff;--preloader-text-color:#000}}@media (max-width:600px){.ml13{font-size:2.6rem!important}}.preloader{display:flex;flex-direction:column;gap:1rem;align-items:center;justify-content:center;position:fixed;padding:12px;top:0;right:0;bottom:0;left:0;width:100vw;height:100vh;background-color:var(--preloader-background-color);z-index:1100;transition:opacity .2s ease-in-out}.ml13{font-size:3.2rem;color:var(--preloader-text-color);letter-spacing:-1px;font-weight:500;font-family:Chillax-Variable,sans-serif;text-align:center}.ml13 .word{display:inline-flex;flex-wrap:wrap;white-space:nowrap}.ml13 .letter{display:inline-block;line-height:1em}</style><div class="preloader"><h2 class="ml13">Advance ruthlessly—whatever the cost!</h2><script>var textWrapper = document.querySelector('.ml13');
        // Split text into words
        var words = textWrapper.textContent.trim().split(' ');

        // Clear the existing content
        textWrapper.innerHTML = '';

        // Wrap each word and its letters in spans
        words.forEach(function(word) {
            var wordSpan = document.createElement('span');
            wordSpan.classList.add('word');
            wordSpan.innerHTML = word.replace(/\S/g, "<span class='letter'>$&</span>");
            textWrapper.appendChild(wordSpan);
            textWrapper.appendChild(document.createTextNode(' ')); // Add space between words
        });

        var animation = anime.timeline({ loop: true })
            .add({
                targets: '.ml13 .letter',
                translateY: [20, 0],
                translateZ: 0,
                opacity: [0, 1],
                filter: ['blur(5px)', 'blur(0px)'],
                easing: "easeOutExpo",
                duration: 1200,
                delay: (el, i) => 300 + 20 * i,
            })
            .add({
                targets: '.ml13 .letter',
                translateY: [0, -20],
                opacity: [1, 0],
                filter: ['blur(0px)', 'blur(5px)'],
                easing: "easeInExpo",
                duration: 1000,
                delay: (el, i) => 15 * i,
                complete: function() {
                    hidePreloader();
                }
            }, '-=700');


        let themeStatus = JSON.parse(localStorage.getItem('REDEFINE-THEME-STATUS'))?.isDark;

        // If the theme status is not found in local storage, check the preferred color scheme
        if (themeStatus === undefined || themeStatus === null) {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                themeStatus = 'dark';
            } else {
                themeStatus = 'light';
            }
        }

        // Now you can use the themeStatus variable in your code
        if (themeStatus) {
            document.documentElement.style.setProperty('--preloader-background-color', '#202124');
            document.documentElement.style.setProperty('--preloader-text-color', '#fff');
        } else {
            document.documentElement.style.setProperty('--preloader-background-color', '#fff');
            document.documentElement.style.setProperty('--preloader-text-color', '#000');
        }

        window.addEventListener('load', function () {
            setTimeout(hidePreloader, 5000); // Call hidePreloader after 5000 milliseconds if not already called by animation
        });

        function hidePreloader() {
            var preloader = document.querySelector('.preloader');
            preloader.style.opacity = '0';
            setTimeout(function () {
                preloader.style.display = 'none';
            }, 200);
        }</script></div><main class="page-container" id="swup"><div class="main-content-container flex flex-col justify-between min-h-dvh"><div class="main-content-header"><header class="navbar-container px-6 md:px-12"><div class="navbar-content transition-navbar"><div class="left"><a class="logo-title" href="/">ReZero&#39;s blog</a></div><div class="right"><div class="desktop"><ul class="navbar-list"><li class="navbar-item"><a href="/"><i class="fa-regular fa-house fa-fw"></i> HOME</a></li><li class="navbar-item"><a href="/categories/"><i class="fa-solid fa-folder fa-fw"></i> CATEGORIES</a></li><li class="navbar-item"><a href="/tags/"><i class="fa-solid fa-tags fa-fw"></i> TAGS</a></li></ul></div><div class="mobile"><div class="icon-item navbar-bar"><div class="navbar-bar-middle"></div></div></div></div></div><div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between"><ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start"><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/"><span>HOME </span><i class="fa-regular fa-house fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/categories/"><span>CATEGORIES </span><i class="fa-solid fa-folder fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/tags/"><span>TAGS </span><i class="fa-solid fa-tags fa-sm fa-fw"></i></a></li></ul><div class="statistics flex justify-around my-2.5"><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">138</div><div class="label text-third-text-color text-sm">Tags</div></a><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">21</div><div class="label text-third-text-color text-sm">Categories</div></a><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">60</div><div class="label text-third-text-color text-sm">Posts</div></a></div></div><div class="window-mask"></div></header></div><div class="main-content-body transition-fade-up"><div class="main-content"><div class="post-page-container flex relative justify-between box-border w-full h-full"><div class="article-content-container"><div class="article-title relative w-full"><div class="w-full flex items-center pt-6 justify-start"><h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">CSAPP</h1></div></div><div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8"><div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]"><img src="/images/redefine-avatar.svg"></div><div class="info flex flex-col justify-between"><div class="author flex items-center"><span class="name text-default-text-color text-lg font-semibold">ReZero</span> <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv4</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fa-regular fa-pen-fancy"></i>&nbsp; <span class="desktop">2020-10-01 12:41</span> <span class="mobile">2020-10-01 12:41</span> <span class="hover-info">Created</span> </span><span class="article-date article-meta-item"><i class="fa-regular fa-wrench"></i>&nbsp; <span class="desktop">2025-04-15 23:03:26</span> <span class="mobile">2025-04-15 23:03:26</span> <span class="hover-info">Updated</span> </span><span class="article-categories article-meta-item"><i class="fa-regular fa-folders"></i>&nbsp;<ul><li><a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a>&nbsp;</li></ul></span><span class="article-tags article-meta-item"><i class="fa-regular fa-tags"></i>&nbsp;<ul><li><a href="/tags/Program/">Program</a>&nbsp;</li><li>| <a href="/tags/OS/">OS</a>&nbsp;</li></ul></span><span class="article-pv article-meta-item"><i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8"><h2 id="Not-be-the-real-thing"><a href="#Not-be-the-real-thing" class="headerlink" title="Not be the real thing"></a>Not be the real thing</h2><ol><li><p>digit might be overfolw</p></li><li><p>float will not be overflow, but could lost precision</p></li></ol><h2 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h2><ol><li>RAM: Random am</li></ol><h2 id="Bit"><a href="#Bit" class="headerlink" title="Bit"></a>Bit</h2><p>Exclusive-Or(XOR) A ^ B</p><p>Union | &#x2F;&#x2F;并</p><p>Complement ~ &#x2F;&#x2F;补</p><p>Intersection &amp; &#x2F;&#x2F;交</p><p>Symmetric difference ^ &#x2F;&#x2F;差</p><h2 id="Integer"><a href="#Integer" class="headerlink" title="Integer"></a>Integer</h2><p>Unsigned：</p><p>$$ B2U(X)&#x3D;\sum_{i&#x3D;0}^{w-1}x_i*2^i $$</p><p>Signed：</p><p>$$ B2T(X)&#x3D;-x_{w-1}<em>2^{w-1}+\sum_{i&#x3D;0}^{w-2}x_i</em>2^i $$</p><h3 id="Type-Conversion"><a href="#Type-Conversion" class="headerlink" title="Type Conversion"></a>Type Conversion</h3><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/unsigned.jpg" title="TypeConversion"><p>If not set keyword(unsigned) in C, then must use U follow number to change the default value(signed) such as 15213U</p><h3 id="Conversion-mutual"><a href="#Conversion-mutual" class="headerlink" title="Conversion mutual"></a>Conversion mutual</h3><ul><li><p>Byte will not changed, but change the interpreted way.</p></li><li><p>Both all will be convert into unsigned if include one unsigned.</p></li></ul><h3 id="Type-extension-amp-Intercept"><a href="#Type-extension-amp-Intercept" class="headerlink" title="Type extension &amp; Intercept"></a>Type extension &amp; Intercept</h3><ul><li><p>Extend: from short to int</p><ul><li>unsigned: plus 0</li><li>signed: plus sign</li></ul></li><li><p>Intercept: from unsigned int to unsigned short</p><ul><li>unsigned: mod operation</li><li>signed: almost mod operation</li></ul></li></ul><h3 id="Calculate-amp-Overflow"><a href="#Calculate-amp-Overflow" class="headerlink" title="Calculate &amp; Overflow"></a>Calculate &amp; Overflow</h3><p>Both w bit unsigned number mutual plus, and get a result w+1 bit. Then it will lose the highest bit, just like mod operation:</p><p>$$s&#x3D;UAdd_w(u,v)&#x3D;u+v ; mod ; 2^w$$</p><p>So as signed number, but change the sign symbol.</p><h2 id="Float"><a href="#Float" class="headerlink" title="Float"></a>Float</h2><p>$$\sum_{k&#x3D;-j}^ib_k\times 2^k$$</p><h3 id="IEEE-standard"><a href="#IEEE-standard" class="headerlink" title="IEEE standard"></a>IEEE standard</h3><p>$$(-1)^s ; M ; 2^E$$</p><p><code>s</code> is sign symbol, <code>M</code> always be [1.0, 2.0) decimal, and <code>E</code> is power.</p><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/decimal.jpg" title="decimal"><p>Exp related E(not equal must, as the limit of bit count), frac related M(So as E)</p><hr><h4 id="Normalized-Values"><a href="#Normalized-Values" class="headerlink" title="Normalized Values"></a>Normalized Values</h4><p>$$v&#x3D;(-1)^s ; M ; 2^E$$</p><ul><li>E &#x3D; Exp - Bias</li><li>Exp: exp encode area unsigned digit</li><li>Bias: as k is exp encode count, which means</li></ul><p>$$2^{k-1} - 1$$</p><pre><code>- single precision: 127 (Exp:1...254,E:-126...127)
- double precision: 1023 (Exp:1...2046, E:-1022...1023)
</code></pre><p>Note: Exp encode only need unsigned digit to operate.</p><p>For M, it must begin with 1: M &#x3D; 1.xxx…x2, and xxx means frac(frac &#x3D; 000.00 corresponding minium M &#x3D; 1.0), when frac&#x3D;111…1, M will be infinite close to 2.0</p><p>For Example: Float F &#x3D; 15213.0</p><p>$$15213_{10}&#x3D;11101101101101_2&#x3D;1.1101101101101_2 \times 2^{13}$$</p><p>So the frac part is the point behind, and Exp &#x3D; E + Bias &#x3D; 12 + 127 &#x3D; 140 &#x3D; 10001100(b)</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0 10001100 11011011011010000000000</span><br><span class="line">s   exp             frac</span><br></pre></td></tr></table></figure></div><h4 id="Denormalized-Values"><a href="#Denormalized-Values" class="headerlink" title="Denormalized Values"></a>Denormalized Values</h4><p><code>E = 1 - Bias</code> And <code>M = 0.xxx...x2</code> But others not changed.</p><p>exp &#x3D; 000…0 &amp; frac &#x3D; 000…0 : 0<br>exp &#x3D; 000…0 &amp; frac !&#x3D; 000…0 : infinite to 0<br>exp &#x3D; 111…1 &amp; frac &#x3D; 000..0 infinite<br>exp &#x3D; 111…1 &amp; frac !&#x3D; 000…0 NaN</p><h4 id="Real-sample"><a href="#Real-sample" class="headerlink" title="Real sample"></a>Real sample</h4><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/normalize.jpg" title="normalize"><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">    s exp  frac   E   值</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line">    0 0000 000   -6   0   # 这部分是非规范化数值，下一部分是规范化值</span><br><span class="line">    0 0000 001   -6   1/8 * 1/64 = 1/512 # 能表示的最接近零的值</span><br><span class="line">    0 0000 010   -6   2/8 * 1/64 = 2/512 </span><br><span class="line">    ...</span><br><span class="line">    0 0000 110   -6   6/8 * 1/64 = 6/512</span><br><span class="line">    0 0000 111   -6   7/8 * 1/64 = 7/512 # 能表示的最大非规范化值</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line">    0 0001 000   -6   8/8 * 1/64 = 8/512 # 能表示的最小规范化值</span><br><span class="line">    0 0001 001   -6   9/8 * 1/64 = 9/512</span><br><span class="line">    ...</span><br><span class="line">    0 0110 110   -1   14/8 * 1/2 = 14/16</span><br><span class="line">    0 0110 111   -1   15/8 * 1/2 = 15/16 # 最接近且小于 1 的值</span><br><span class="line">    0 0111 000    0   8/8 * 1 = 1</span><br><span class="line">    0 0111 001    0   9/8 * 1 = 9/8      # 最接近且大于 1 的值</span><br><span class="line">    0 0111 010    0   10/8 * 1 = 10/8</span><br><span class="line">    ...</span><br><span class="line">    0 1110 110    7   14/8 * 128 = 224</span><br><span class="line">    0 1110 111    7   15/8 * 128 = 240   # 能表示的最大规范化值</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line">    0 1111 000   n/a  无穷               # 特殊值</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p>Note:</p><ul><li>exp &#x3D; 0000(Denormalize) 1&#x2F;8 is the distance</li></ul><hr><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  原数值       舍入结果    原因</span><br><span class="line">2.8949999      2.89    不到一半，正常四舍五入</span><br><span class="line">2.8950001      2.90    超过一半，正常四舍五入</span><br><span class="line">2.8950000      2.90    刚好在一半时，保证最后一位是偶数，所以向上舍入</span><br><span class="line">2.8850000      2.88    刚好在一半时，保证最后一位是偶数，所以向下舍入</span><br></pre></td></tr></table></figure></div><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  十进制    二进制     舍入结果  十进制    原因</span><br><span class="line">2 又 3/32  10.00011   10.00     2      不到一半，正常四舍五入</span><br><span class="line">2 又 3/16  10.00110   10.01  2 又 1/4   超过一半，正常四舍五入</span><br><span class="line">2 又 7/8   10.11100   11.00     3      刚好在一半时，保证最后一位是偶数，所以向上舍入</span><br><span class="line">2 又 5/8   10.10100   10.10  2 又 1/2   刚好在一半时，保证最后一位是偶数，所以向下舍入</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/plusmult.jpeg" title="plus&amp;mult"><h2 id="Data-in-Memory"><a href="#Data-in-Memory" class="headerlink" title="Data in Memory"></a>Data in Memory</h2><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/address.jpg" title="address"><p>Internet: Big Endian</p><p>x86 OR ARM: Little Endian</p><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/endian.jpg" title="Endian"><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// Check the num format</span><br><span class="line">typedef unsigned char *pointer;</span><br><span class="line">void show_bytes(pointer start, size_t len) &#123;</span><br><span class="line">	size_t i;</span><br><span class="line">	for (i = 0; i &lt; len; i++)</span><br><span class="line">		printf(&quot;%p\t0x%.2x\n&quot;, start+i, start[i]);</span><br><span class="line">	printf(&quot;\n&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>%p: point, %x: Hex, Execute as:</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int a = 15213;</span><br><span class="line">printf(&quot;int a = 15213;\n&quot;);</span><br><span class="line">show_bytes((pointer) &amp;a, sizeof(int));</span><br></pre></td></tr></table></figure></div><hr><h2 id="Basic"><a href="#Basic" class="headerlink" title="Basic"></a>Basic</h2><h3 id="C2M"><a href="#C2M" class="headerlink" title="C2M"></a>C2M</h3><p>.c (gcc -0g 0S) -&gt; .s<br>.s (gcc OR as) -&gt; .o<br>.o (with lib.a operated by gcc OR ld) execute.</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">plus</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> y)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">sumstore</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> y, <span class="type">long</span> *dest)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> t = plus(x, y);</span><br><span class="line">    *dest = t;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p>appropriate code:</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sumstore:</span><br><span class="line">    pushq   %rbx</span><br><span class="line">    movq    %rbx, %rbx</span><br><span class="line">    call    plus</span><br><span class="line">    movq    %rax, (%rbx)</span><br><span class="line">    popq    %rbx</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure></div><hr><p>Processor:</p><ul><li>Storage: Memory &amp; Register</li><li>Calc: Memory &amp; Register</li><li>Transfer: condition call OR condition branch</li></ul><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// C 代码</span><br><span class="line">*dest = t;</span><br><span class="line">// 对应的汇编代码</span><br><span class="line">movq    %rax, (%rbx)</span><br><span class="line">// 对应的对象代码</span><br><span class="line">0x40059e:   46 89 03</span><br></pre></td></tr></table></figure></div><h3 id="Assembly"><a href="#Assembly" class="headerlink" title="Assembly"></a>Assembly</h3><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/x86_64.jpg" title="x86_64"><p>General purpose register</p><ul><li>%rax(%eax) 用于做累加</li><li>%rcx(%ecx) 用于计数</li><li>%rdx(%edx) 用于保存数据</li><li>%rbx(%ebx) 用于做内存查找的基础地址</li><li>%rsi(%esi) 用于保存源索引值</li><li>%rdi(%edi) 用于保存目标索引值</li></ul><hr><p><em>%rsp(%esp) 和 %rbp(%ebp) 则是作为栈指针和基指针来使用的</em></p><hr><p>movq Sour:[Imm|Reg|Mem], Dest[Reg|Mem] (But No Mem Mem)</p><p><code>D(Rb, Ri, S) -&gt; Mem[Reg[Rb]+S*Reg[Ri]+D]</code></p><ul><li><p>D - 常数偏移量</p></li><li><p>Rb - 基寄存器</p></li><li><p>Ri - 索引寄存器，不能是 %rsp</p></li><li><p>S - 系数</p></li><li><p>(Rb, Ri) -&gt; Mem[Reg[Rb]+Reg[Ri]]</p></li><li><p>D(Rb, Ri) -&gt; Mem[Reg[Rb]+Reg[Ri]+D]</p></li><li><p>(Rb, Ri, S) -&gt; Mem[Reg[Rb]+S*Reg[Ri]]</p></li></ul><hr><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">long m12(long x)</span><br><span class="line">&#123;</span><br><span class="line">    return x * 12;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">leaq (%rdi, %rdi, 2), %rax # t &lt;- x+x*2</span><br><span class="line">salq $2, %rax              # return t &lt;&lt; 2</span><br></pre></td></tr></table></figure></div><p>More orders:</p><ul><li><p>addq Src, Dest -&gt; Dest &#x3D; Dest + Src</p></li><li><p>subq Src, Dest -&gt; Dest &#x3D; Dest - Src</p></li><li><p>imulq Src, Dest -&gt; Dest &#x3D; Dest * Src</p></li><li><p>salq Src, Dest -&gt; Dest &#x3D; Dest &lt;&lt; Src</p></li><li><p>sarq Src, Dest -&gt; Dest &#x3D; Dest &gt;&gt; Src</p></li><li><p>shrq Src, Dest -&gt; Dest &#x3D; Dest &gt;&gt; Src</p></li><li><p>xorq Src, Dest -&gt; Dest &#x3D; Dest ^ Src</p></li><li><p>andq Src, Dest -&gt; Dest &#x3D; Dest &amp; Src</p></li><li><p>orq Src, Dest -&gt; Dest &#x3D; Dest | Src</p></li><li></li><li><p>incq Dest -&gt; Dest &#x3D; Dest + 1</p></li><li><p>decq Dest -&gt; Dest &#x3D; Dest - 1</p></li><li><p>negq Dest -&gt; Dest &#x3D; -Dest</p></li><li><p>notq Dest -&gt; Dest &#x3D; ~Dest</p></li></ul><h2 id="Flow-Control"><a href="#Flow-Control" class="headerlink" title="Flow Control"></a>Flow Control</h2><ul><li>临时数据存放在 (%rax, …)</li><li>运行时栈的地址存储在 (%rsp) 中</li><li>目前的代码控制点存储在 (%rip, …) 中</li><li>目前测试的状态放在 CF, ZF, SF, OF 中</li></ul><h3 id="Condition-amp-Jump"><a href="#Condition-amp-Jump" class="headerlink" title="Condition &amp; Jump"></a>Condition &amp; Jump</h3><ul><li>CF: Carry Flag (针对无符号数)</li><li>ZF: Zero Flag</li><li>SF: Sign Flag (针对有符号数)</li><li>OF: Overflow Flag (针对有符号数)</li></ul><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">long absdiff(long x, long y)</span><br><span class="line">&#123;</span><br><span class="line">    long result;</span><br><span class="line">    if (x &gt; y)</span><br><span class="line">        result = x-y;</span><br><span class="line">    else</span><br><span class="line">        result = y-x;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>%rdi save x，%rsi save y， %rax save return.</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">absdiff:</span><br><span class="line">    cmpq    %rsi, %rdi</span><br><span class="line">    jle     .L4</span><br><span class="line">    movq    %rdi, %rax</span><br><span class="line">    subq    %rsi, %rax</span><br><span class="line">    ret</span><br><span class="line">.L4:    # x &lt;= y</span><br><span class="line">    movq    %rsi, %rax</span><br><span class="line">    subq    %rdi, %rax</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure></div><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">long absdiff_goto(long x, long y)</span><br><span class="line">&#123;</span><br><span class="line">    long result;</span><br><span class="line">    int ntest = x &lt;= y;</span><br><span class="line">    if (ntest) goto Else;</span><br><span class="line">    result = x-y;</span><br><span class="line">    goto Done;</span><br><span class="line">Else:</span><br><span class="line">    result = y-x;</span><br><span class="line">Done:</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">val = Test ? Then_Expr : Else_Expr;</span><br><span class="line">val = x&gt;y ? x-y : y-x;</span><br></pre></td></tr></table></figure></div><p>To Goto</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">	ntest = !Test;</span><br><span class="line">	if (ntest) goto Else;</span><br><span class="line">	value = Then_Expr;</span><br><span class="line">	goto Done;</span><br><span class="line">Else:</span><br><span class="line">	val = Else_Expr;</span><br><span class="line">Done:</span><br><span class="line">	...</span><br></pre></td></tr></table></figure></div><p>Calc all to avoid the reset assembly line operation</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">result = Then_Expr;</span><br><span class="line">eval = Else_Expr;</span><br><span class="line">nt = !Test;</span><br><span class="line">if (nt) result = eval;</span><br><span class="line">return result;</span><br></pre></td></tr></table></figure></div><p>Such as:</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">absdiff:</span><br><span class="line">    movq    %rdi, %rax  # x</span><br><span class="line">    subq    %rsi, %rax  # result = x-y</span><br><span class="line">    movq    %rsi, %rdx</span><br><span class="line">    subq    %rdi, %rdx  # eval = y-x</span><br><span class="line">    cmpq    %rsi, %rdi  # x:y</span><br><span class="line">    cmovle  %rdx, %rax  # if &lt;=, result = eval</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure></div><p>Not suited:</p><ul><li><p>Much more calc in the two branches</p></li><li><p><code>val = p ? *p : 0;</code> some interesting happen</p></li><li><p><code>val = x &gt; 0? x *= 7: x *= 3</code> x will change</p></li></ul><h4 id="Do-While"><a href="#Do-While" class="headerlink" title="Do While"></a>Do While</h4><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// Do While 的 C 语言代码</span><br><span class="line">long pcount_do(unsigned long x)</span><br><span class="line">&#123;</span><br><span class="line">    long result = 0;</span><br><span class="line">    do &#123;</span><br><span class="line">        result += x &amp; 0x1;</span><br><span class="line">        x &gt;&gt;= 1;</span><br><span class="line">    &#125; while (x);</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line">// Goto 版本</span><br><span class="line">long pcount_goto(unsigned long x)</span><br><span class="line">&#123;</span><br><span class="line">    long result = 0;</span><br><span class="line">loop:</span><br><span class="line">    result += x &amp; 0x1;</span><br><span class="line">    x &gt;&gt;= 1;</span><br><span class="line">    if (x) goto loop;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>To assembly:</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    movl    $0, %eax    # result = 0</span><br><span class="line">.L2:                    # loop:</span><br><span class="line">    movq    %rdi, %rdx</span><br><span class="line">    andl    $1, %edx    # t = x &amp; 0x1</span><br><span class="line">    addq    %rdx, %rax  # result += t</span><br><span class="line">    shrq    %rdi        # x &gt;&gt;= 1</span><br><span class="line">    jne     .L2         # if (x) goto loop</span><br><span class="line">    rep; ret</span><br></pre></td></tr></table></figure></div><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// C Code</span><br><span class="line">do</span><br><span class="line">	Body</span><br><span class="line">	while (Test);</span><br><span class="line">// Goto Version</span><br><span class="line">loop:</span><br><span class="line">	Body</span><br><span class="line">	if (Test)</span><br><span class="line">		goto loop</span><br><span class="line"></span><br><span class="line">// C While version</span><br><span class="line">while (Test)</span><br><span class="line">	Body</span><br><span class="line">// Goto Version</span><br><span class="line">	goto test;</span><br><span class="line">loop:</span><br><span class="line">	Body</span><br><span class="line">test:</span><br><span class="line">	if (Test)</span><br><span class="line">		goto loop;</span><br><span class="line">done:</span><br></pre></td></tr></table></figure></div><p>Turn on <code>-01</code> Optimize option, <code>While</code> will be transfer into Do-While, then transfer into Goto, Because Do-While execute so faster, which much more suit CPU calc model.</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// For</span><br><span class="line">for (Init; Test; Update)</span><br><span class="line">	Body</span><br><span class="line">	</span><br><span class="line">// While Version</span><br><span class="line">Init;</span><br><span class="line">while (Test) &#123;</span><br><span class="line">	Body</span><br><span class="line">	Update;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>Switch:</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">long switch_eg (long x, long y, long z)&#123;</span><br><span class="line">	long w = 1;</span><br><span class="line">	switch (x) &#123;</span><br><span class="line">		case 1:</span><br><span class="line">			w = y*z;</span><br><span class="line">			break;</span><br><span class="line">		case 2:</span><br><span class="line">			w = y/z;</span><br><span class="line">			// fall through</span><br><span class="line">		case 3:</span><br><span class="line">			w += z;</span><br><span class="line">			break;</span><br><span class="line">		case 5:</span><br><span class="line">		case 6:</span><br><span class="line">			w -= z;</span><br><span class="line">			break;</span><br><span class="line">		default:</span><br><span class="line">			w = 2;</span><br><span class="line">	&#125;</span><br><span class="line">	return w;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>We will use jump table:<br>%rdi is x, %rsi is y, %rdx is z, %rax is return</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">switch_eg:</span><br><span class="line">    movq    %rdx, %rcx</span><br><span class="line">    cmpq    $6, %rdi    # x:6</span><br><span class="line">    ja      .L8</span><br><span class="line">    jmp     *.L4(, %rdi, 8)</span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">Jump table as</span><br><span class="line">--------------</span><br><span class="line"></span><br><span class="line">.section    .rodata</span><br><span class="line">    .align 8</span><br><span class="line">.L4:</span><br><span class="line">    .quad   .L8 # x = 0</span><br><span class="line">    .quad   .L3 # x = 1</span><br><span class="line">    .quad   .L5 # x = 2</span><br><span class="line">    .quad   .L9 # x = 3</span><br><span class="line">    .quad   .L8 # x = 4</span><br><span class="line">    .quad   .L7 # x = 5</span><br><span class="line">    .quad   .L7 # x = 6</span><br></pre></td></tr></table></figure></div><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/switch.png" title="switch"><h2 id="Process-call"><a href="#Process-call" class="headerlink" title="Process call"></a>Process call</h2><ul><li>Delivery Control: How to begin, and return back the begin</li><li>Delivery Data: Args and return value.</li><li>Memory Manage: How to free and malloc memory.</li></ul><h3 id="Stack-Structure"><a href="#Stack-Structure" class="headerlink" title="Stack Structure"></a>Stack Structure</h3><p>%rsp is stack point</p><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/stackp.jpg" title="stackp"><h3 id="Call-ways"><a href="#Call-ways" class="headerlink" title="Call ways"></a>Call ways</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// multstore 函数</span><br><span class="line">void multstore (long x, long, y, long *dest)</span><br><span class="line">&#123;</span><br><span class="line">    long t = mult2(x, y);</span><br><span class="line">    *dest = t;</span><br><span class="line">&#125;</span><br><span class="line">// mult2 函数</span><br><span class="line">long mult2(long a, long b)</span><br><span class="line">&#123;</span><br><span class="line">    long s = a * b;</span><br><span class="line">    return s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// Assembly</span><br><span class="line">0000000000400540 &lt;multstore&gt;:</span><br><span class="line">    # x 在 %rdi 中，y 在 %rsi 中，dest 在 %rdx 中</span><br><span class="line">    400540: push    %rbx            # 通过压栈保存 %rbx</span><br><span class="line">    400541: mov     %rdx, %rbx      # 保存 dest</span><br><span class="line">    400544: callq   400550 &lt;mult2&gt;  # 调用 mult2(x, y)</span><br><span class="line">    # t 在 %rax 中</span><br><span class="line">    400549: mov     %rax, (%rbx)    # 结果保存到 dest 中</span><br><span class="line">    40054c: pop     %rbx            # 通过出栈恢复原来的 %rbx</span><br><span class="line">    40054d: retq                    # 返回</span><br><span class="line">0000000000400550 &lt;mult2&gt;:</span><br><span class="line">    # a 在 %rdi 中，b 在 %rsi 中</span><br><span class="line">    400550: mov     %rdi, %rax      # 得到 a 的值</span><br><span class="line">    400553: imul    %rsi, %rax      # a * b</span><br><span class="line">    # s 在 %rax 中</span><br><span class="line">    400557: retq                    # 返回</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p>call: 将当前的IP 或者 CS:IP 压入栈中, 跳转到指定位置<br>ret : 用栈中所保存的数据赋值给IP的， 跳转回来</p><hr><p>参数没有超过六个，那么会放在：%rdi, %rsi, %rdx, %rcx, %r8, %r9 中。</p><p>如果超过了，会另外放在一个栈中。而返回值会放在 %rax 中</p><p>A Frame will be assigned to every call process by on stack which include three as follows:</p><ul><li>返回信息</li><li>本地存储（如果需要）</li><li>临时空间（如果需要）</li></ul><p>Call then alloc, free when return.</p><hr><p>x86_64&#x2F;Linux, fixed in that:</p><ul><li>Argument Build: 需要使用的参数</li><li>如果不能保存在寄存器中，会把一些本地变量放在这里</li><li>已保存的寄存器上下文</li><li>老的栈帧的指针（可选）</li></ul><p>While caller include:</p><ul><li>返回地址（因为 call 指令被压入栈的）</li><li>调用所需的参数</li></ul><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/frame.jpg" title="frame"><h4 id="Recursive"><a href="#Recursive" class="headerlink" title="Recursive"></a>Recursive</h4><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">long pcount_r(unsigned long x) &#123;</span><br><span class="line">	if (x == 0)</span><br><span class="line">		return 0;</span><br><span class="line">	else</span><br><span class="line">		return (x &amp; 1) + pcount_r(x &gt;&gt; 1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pcount_r:</span><br><span class="line">    mov     $0, %eax</span><br><span class="line">    testq   %rdi, %rdi</span><br><span class="line">    je      .L6</span><br><span class="line">    push    %rbx</span><br><span class="line">    movq    %rdi, %rbx</span><br><span class="line">    andl    $1, %ebx</span><br><span class="line">    shrq    %rdi</span><br><span class="line">    call    pcount_r</span><br><span class="line">    addq    %rbx, %rax</span><br><span class="line">    popq    %rbx</span><br><span class="line">.L6:</span><br><span class="line">    rep; ret</span><br></pre></td></tr></table></figure></div><h2 id="Data-Storage"><a href="#Data-Storage" class="headerlink" title="Data Storage"></a>Data Storage</h2><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/zone.jpg" title="zone"><p>Struct:</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct rec </span><br><span class="line">&#123;</span><br><span class="line">    int a[4];</span><br><span class="line">    size_t i;       </span><br><span class="line">    struct rect *next;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/struct1.jpg" title="struct1"><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct S1</span><br><span class="line">&#123;</span><br><span class="line">    char c;</span><br><span class="line">    int i[2];</span><br><span class="line">    double v;</span><br><span class="line">&#125; *p;</span><br></pre></td></tr></table></figure></div><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/struct2.jpg" title="struct2"><blockquote><p>Align theory:</p></blockquote><blockquote><p>Win: 如果数据类型需要 K 个字节，那么地址都必须是 K 的倍数</p></blockquote><blockquote><p>Linux: 2字节数据类型的地址必须为2的倍数，较大的数据类型（int,double,float）的地址必须是4的倍数</p></blockquote><p>So we could design struct like this(big bit number on the front):</p><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/good.png" title="good"><h2 id="Cache-overflow"><a href="#Cache-overflow" class="headerlink" title="Cache overflow"></a>Cache overflow</h2><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/Morgnize.jpg" title="Morgnize"><blockquote><p>最上面是运行时栈，有 8MB 的大小限制，一般用来保存局部变量。然后是堆，动态的内存分配会在这里处理，例如 malloc(), calloc(), new() 等。然后是数据，指的是静态分配的数据，比如说全局变量，静态变量，常量字符串。最后是共享库等可执行的机器指令，这一部分是只读的。</p></blockquote><blockquote><p>可以见到，栈在最上面，也就是说，栈再往上就是另一个程序的内存范围了，这种时候我们就可以通过这种方式修改内存的其他部分了。</p></blockquote><p>Sample:</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">void echo() &#123;</span><br><span class="line">	char buf[4]; // 太小</span><br><span class="line">	gets(buf);</span><br><span class="line">	puts(buf);</span><br><span class="line">&#125;</span><br><span class="line">void call_echo() &#123;</span><br><span class="line">	echo();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">00000000004006cf &lt;echo&gt;:</span><br><span class="line">    4006cf: 48 83 ec 18         sub   $0x18, %rsp</span><br><span class="line">    4006d3: 48 89 e7            mov   %rsp, %rdi</span><br><span class="line">    4006d6: e8 a5 ff ff ff      callq 400680 &lt;gets&gt;</span><br><span class="line">    4006db: 48 89 e7            mov   %rsp, %rdi</span><br><span class="line">    4006de: e8 3d fe ff ff      callq 400520 &lt;puts@plt&gt;</span><br><span class="line">    4006e3: 48 83 c4 18         add   $0x18, %rsp</span><br><span class="line">    4006e7: c3                  retq</span><br><span class="line"># call_echo 部分</span><br><span class="line">    4006e8: 48 83 ec 08         sub   $0x8, %rsp</span><br><span class="line">    4006ec: b8 00 00 00 00      mov   $0x0, %eax</span><br><span class="line">    4006f1: e8 d9 ff ff ff      callq 4006cf &lt;echo&gt;</span><br><span class="line">    4006f6: 48 83 c4 08         add   $0x8, %rsp</span><br><span class="line">    4006fa: c3                  retq</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p>0x18 not 4, before 4006d6</p><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/4006d6.jpg" title="4006d6"><p>See, the call_echo frame saved 4006f6 order, and when we type <code>01234567890123456789012</code></p><p>Cache like this(No Segment Fault):</p><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/cache.jpg" title="cache"><p>but more will override the 4006f6 get 400034(the back next order)</p><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/attack.jpg" title="attack"><p>返回导向编程: 可以利用修改已有的代码，来绕过系统和编译器的保护机制，攻击者控制堆栈调用以劫持程序控制流并执行针对性的机器语言指令序列（称为Gadgets）。每一段 gadget 通常结束于 return 指令，并位于共享库代码中的子程序。系列调用这些代码，攻击者可以在拥有更简单攻击防范的程序内执行任意操作。</p><h2 id="Optimize"><a href="#Optimize" class="headerlink" title="Optimize"></a>Optimize</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// 把 nxn 的矩阵 a 的每一行加起来，存到向量 b 中</span><br><span class="line">void sum_rows1(double *a, double *b, long n)</span><br><span class="line">&#123;</span><br><span class="line">    long i, j;</span><br><span class="line">    for (i = 0; i &lt; n; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        b[i] = 0;</span><br><span class="line">        for (j = 0; j &lt; n; j++)</span><br><span class="line">            b[i] += a[i*n + j];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 把 nxn 的矩阵 a 的每一行加起来，存到向量 b 中</span><br><span class="line">void sum_rows2(double *a, double *b, long n)</span><br><span class="line">&#123;</span><br><span class="line">    long i, j;</span><br><span class="line">    for (i = 0; i &lt; n; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        double val = 0;</span><br><span class="line">        for (j = 0; j &lt; n; j++)</span><br><span class="line">            val += a[i*n + j];</span><br><span class="line">        b[i] = val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>To remove quote memory</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// 把 nxn 的矩阵 a 的每一行加起来，存到向量 b 中</span><br><span class="line">void sum_rows2(double *a, double *b, long n)</span><br><span class="line">&#123;</span><br><span class="line">    long i, j;</span><br><span class="line">    for (i = 0; i &lt; n; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        double val = 0;</span><br><span class="line">        for (j = 0; j &lt; n; j++)</span><br><span class="line">            val += a[i*n + j];</span><br><span class="line">        b[i] = val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># sum_rows2 内循环</span><br><span class="line">.L10:</span><br><span class="line">    addsd   (%rdi), %xmm0   # 浮点数载入 + 加法</span><br><span class="line">    addq    $9, %rdi</span><br><span class="line">    cmpq    %rax, %rdi</span><br><span class="line">    jne     .L10</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p>这个问题，如果不是对处理器执行指令的机制有一定了解的话，可能会难以理解。</p><p>现代处理器普遍采用超标量设计，也就是基于流水线来进行指令的处理，也就是说，当执行当前指令时，接下来要执行的几条指令已经进入流水线的处理流程了。</p><p>这个很重要，对于顺序执行来说，不会有任何问题，但是对于条件分支来说，在跳转指令时可能会改变程序的走向，也就是说，之前载入的指令可能是无效的。这个时候就只能清空流水线，然后重新进行载入。为了减少清空流水线所带来的性能损失，处理器内部会采用称为『分支预测』的技术。</p><p>比方说在一个循环中，根据预测，可能除了最后一次跳出循环的时候会判断错误之外，其他都是没有问题的。这就可以接受，但是如果处理器不停判断错误的话（比方说代码逻辑写得很奇怪），性能就会得到极大的拖累。</p><p>分支问题有些时候会成为最主要的影响性能的因素，但有的时候其实很难避免。</p><hr><h2 id="Base-concept"><a href="#Base-concept" class="headerlink" title="Base concept"></a>Base concept</h2><p>容量 Capacity &#x3D; 每个扇区的字节数(bytes&#x2F;sector) x 磁道上的平均扇区数(avg sectors&#x2F;track) x 磁盘一面的磁道数(tracks&#x2F;surface) x 磁盘的面数(surfaces&#x2F;platter) x 硬盘包含的磁盘数(platters&#x2F;disk)</p><p>总的访问时间 Taccess &#x3D; 寻址时间 Tavg seek + 旋转时间 Tavg rotation + 传输时间 Tavg transfer</p><p>主要决定访问时间的是寻址时间和旋转延迟；读取一个扇区的第一个比特是非常耗时的，之后的都几乎可以忽略不计；硬盘比 SRAM 慢 40,000 倍，比 DRAM 慢 2500 倍。</p><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/disk.jpg" title="disk"> <img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/hostline.jpg" title="hostline"><p>假设 CPU 需要从硬盘中读取一些数据，会给定<code>指令</code>，<code>逻辑块编号</code>和<code>目标地址</code>，并发送给磁盘控制器。然后磁盘控制器会读取对应的数据，并通过 DMA(direct memory access)把数据传输到内存中；传输完成后，磁盘控制器通过中断的方式通知 CPU，然后 CPU 完成之后的工作</p><h3 id="Memory-Hierarchy"><a href="#Memory-Hierarchy" class="headerlink" title="Memory Hierarchy"></a>Memory Hierarchy</h3><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/Hierarch.jpg" title="Hierarch"><blockquote><p>每一层都可以看作是下一层的缓存。利用局部性原理，程序会更倾向于访问第 k 层的数据，而非第 k+1 层，这样就减少了访问时间。</p></blockquote><table><thead><tr><th align="left">缓存类型</th><th align="center">缓存内容</th><th align="right">缓存位置</th><th align="right">延迟(时钟周期)</th><th align="right">管理者</th></tr></thead><tbody><tr><td align="left">寄存器</td><td align="center">4-8 字节的字</td><td align="right">CPU 内核</td><td align="right">0</td><td align="right">编译器</td></tr><tr><td align="left">TLB</td><td align="center">地址翻译</td><td align="right">芯片 TLB</td><td align="right">0</td><td align="right">内存管理单元</td></tr><tr><td align="left">L1 缓存</td><td align="center">64 字节的块</td><td align="right">芯片 L1 缓存</td><td align="right">4</td><td align="right">硬件</td></tr><tr><td align="left">L2 缓存</td><td align="center">64 字节的块</td><td align="right">芯片 L2 缓存</td><td align="right">10</td><td align="right">硬件</td></tr><tr><td align="left">虚拟内存</td><td align="center">4 KB 的页</td><td align="right">主存</td><td align="right">100</td><td align="right">硬件 + 操作系统</td></tr><tr><td align="left">缓冲区缓存</td><td align="center">文件的部分内容</td><td align="right">主存</td><td align="right">100</td><td align="right">操作系统</td></tr><tr><td align="left">磁盘缓存</td><td align="center">磁盘扇区</td><td align="right">磁盘控制器</td><td align="right">100,000</td><td align="right">磁盘固件</td></tr><tr><td align="left">网络缓冲区缓存</td><td align="center">文件的部分内容</td><td align="right">本地磁盘</td><td align="right">10,000,000</td><td align="right">NFS 客户端</td></tr><tr><td align="left">浏览器缓存</td><td align="center">网页</td><td align="right">本地磁盘</td><td align="right">10,000,000</td><td align="right">网络浏览器</td></tr><tr><td align="left">Web 缓存</td><td align="center">网页</td><td align="right">远程服务器磁盘</td><td align="right">1,000,000,000	Web</td><td align="right">代理服务器</td></tr></tbody></table><p>Cache miss</p><ul><li>强制性失效(Cold&#x2F;compulsory Miss): CPU 第一次访问相应缓存块，缓存中肯定没有对应数据，这是不可避免的</li><li>冲突失效(Confilict Miss): 在直接相联或组相联的缓存中，不同的缓存块由于索引相同相互替换，引起的失效叫做冲突失效<ul><li>假设这里有 32KB 直接相联的缓存</li><li>如果有两个 8KB 的数据需要来回访问，但是这两个数组都映射到相同的地址，缓存大小足够存储全部的数据，但是因为相同地址发生了冲突需要来回替换，发生的失效则全都是冲突失效（第一次访问失效依旧是强制性失效），这时缓存并没有存满</li></ul></li><li>容量失效(Capacity Miss): 有限的缓存容量导致缓存放不下而被替换，被替换出去的缓存块再被访问，引起的失效叫做容量失效<ul><li>假设这里有 32KB 直接相联的缓存</li><li>如果有一个 64KB 的数组需要重复访问，数组的大小远远大于缓存大小，没办法全部放入缓存。第一次访问数组发生的失效全都是强制性失效。之后再访问数组，再发生的失效则全都是容量失效，这时缓存已经存满，容量不足以存储全部数据</li></ul></li></ul><h2 id="Cache-Memory"><a href="#Cache-Memory" class="headerlink" title="Cache Memory"></a>Cache Memory</h2><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/cpu.jpg" title="Cpu"><ul><li>S 表示集合(set)数量</li><li>E 表示数据行(line)的数量</li><li>B 表示每个缓存块(block)保存的字节数目</li></ul><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/cachecalc.jpg" title="cachecalc"><p>C &#x3D; E * S * B</p><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/index.jpg" title="index"><h3 id="Read"><a href="#Read" class="headerlink" title="Read:"></a>Read:</h3><p>set index: set; tag: compare to every line; block offset: line offset</p><p>If E &#x3D; 1: Direct Mapped Cache</p><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/direct.jpg" title="DIRECT"><p>| 寻址空间是 M&#x3D;16 字节，也就是 4 位的地址，对应 B&#x3D;2, S&#x3D;4, E&#x3D;1</p><blockquote><p>先从 set index 确定那个 set，然后看 valid 位，接着利用 t bits 分别和每个 line 的 tag 进行比较，如果匹配则命中，那么返回 4 5 位置的数据，如果不匹配，就需要替换，可以随机替换，也可以用 least recently used(LRU) 来进行替换</p></blockquote><hr><h2 id="Complie"><a href="#Complie" class="headerlink" title="Complie"></a>Complie</h2><p>预处理器：将 C 语言代码(da.c)转化成 da.i 文件(gcc –E)，对应于预处理命令 cpp<br>编译器：C 语言代码(da.c, wang.c)经过编译器的处理(gcc -0g -S)成为汇编代码(da.s, wang.s)<br>汇编器：汇编代码(da.s, wang.s)经过汇编器的处理(gcc 或 as)成为对象程序(da.o, wang.o)<br>链接器：对象程序(da.o, wang.o)以及所需静态库(lib.a)经过链接器的处理(gcc 或 ld)最终成为计算机可执行的程序<br>加载器：将可执行程序加载到内存并进行执行，loader 和 ld-linux.so</p><p>head file search rule:</p><ol><li>所有头文件的搜寻会从 -I 开始</li><li>然后找环境变量 C_INCLUDE_PATH, CPLUS_INCLUDE_PATH, OBJC_INCLUDE_PATH 指定的路径</li><li>再找默认目录(&#x2F;usr&#x2F;include, &#x2F;usr&#x2F;local&#x2F;include, &#x2F;usr&#x2F;lib&#x2F;gcc-lib&#x2F;i386-linux&#x2F;2.95.2&#x2F;include 等等)</li></ol><h3 id="Object-files"><a href="#Object-files" class="headerlink" title="Object files"></a>Object files</h3><p>所谓的对象文件(Object File)实际上是一个统称，具体来说有以下三种形式：</p><ul><li>可重定位目标文件 Relocatable object file (.o file)<ul><li>每个 .o 文件都是由对应的 .c 文件通过编译器和汇编器生成，包含代码和数据，可以与其他可重定位目标文件合并创建一个可执行或共享的目标文件</li></ul></li><li>可执行目标文件 Executable object file (a.out file)<ul><li>由链接器生成，可以直接通过加载器加载到内存中充当进程执行的文件，包含代码和数据</li></ul></li><li>共享目标文件 Shared object file (.so file)<ul><li>在 windows 中被称为 Dynamic Link Libraries(DLLs)，是类特殊的可重定位目标文件，可以在链接(静态共享库)时加入目标文件或加载时或运行时(动态共享库)被动态的加载到内存并执行</li></ul></li></ul><h3 id="Object-format"><a href="#Object-format" class="headerlink" title="Object format"></a>Object format</h3><img lazyload src="/images/loading.svg" data-src="/2020/10/01/csapp/oformat.jpg" title="objectformat"><p>ELF header</p><ul><li>包含 word size, byte ordering, file type (.o, exec, .so), machine type, etc</li></ul><p>Segment header table</p><ul><li>包含 page size, virtual addresses memory segments(sections), segment sizes</li></ul><p>.text section</p><ul><li>代码部分</li></ul><p>.rodata section</p><ul><li>只读数据部分，例如跳转表</li></ul><p>.data section</p><ul><li>初始化的全局变量</li></ul><p>.bss section</p><ul><li>未初始化的全局变量</li></ul><p>.symtab section</p><ul><li>包含 symbol table, procudure 和 static variable names 以及 section names 和 location</li></ul><p>.rel.txt section</p><ul><li>.text section 的重定位信息</li></ul><p>.rel.data section</p><ul><li>.data section 的重定位信息</li></ul><p>.debug section</p><ul><li>包含 symbolic debugging (gcc -g) 的信息</li></ul><p>Section header table</p><ul><li>每个 section 的大小和偏移量</li></ul><p>链接器实际上会处理三种不同的符号，对应于代码中不同写法的部分：</p><ul><li>全局符号 Global symbols<ul><li>在当前模块中定义，且可以被其他代码引用的符号，例如非静态 C 函数和非静态全局变量</li></ul></li><li>外部符号 External symbols<ul><li>同样是全局符号，但是是在其他模块（也就是其他的源代码）中定义的，但是可以在当前模块中引用</li></ul></li><li>本地符号 Local symbols<ul><li>在当前模块中定义，只能被当前模块引用的符号，例如静态函数和静态全局变量</li><li>注意，Local linker symbol 并不是 local program variables</li></ul></li></ul><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// 文件 main.c</span><br><span class="line">int sum(int *a, int n);</span><br><span class="line">int array[2] = &#123;1, 2&#125;; // 变量 array 在此定义</span><br><span class="line">int main() // 定义了一个全局函数</span><br><span class="line">&#123;</span><br><span class="line">    int val = sum(array, 2);</span><br><span class="line">    // val 是局部变量，链接器并不知道</span><br><span class="line">    // sum 函数是一个全局引用</span><br><span class="line">    // array 变量是一个全局引用</span><br><span class="line">    return val;</span><br><span class="line">&#125;</span><br><span class="line">// -----------------------------------------</span><br><span class="line">// 文件 sum.c</span><br><span class="line">int sum(int *a, int n) // 定义了一个全局函数</span><br><span class="line">&#123;</span><br><span class="line">    int i, s = 0;</span><br><span class="line">    // i 和 s 是局部变量，链接器并不知道</span><br><span class="line">    for (i = 0; i &lt; n; i++)</span><br><span class="line">        s += a[i];</span><br><span class="line">    </span><br><span class="line">    return s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p>链接器只知道非静态的全局变量&#x2F;函数，不了解局部变量</p><ul><li>局部非静态变量会保存在栈中</li><li>局部静态变量会保存在 .bss 或 .data 中</li></ul></div><div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8"><div class="article-copyright-info-container"><ul><li><strong>Title:</strong> CSAPP</li><li><strong>Author:</strong> ReZero</li><li><strong>Created at :</strong> 2020-10-01 12:41:00</li><li><strong>Updated at :</strong> 2025-04-15 23:03:26</li><li><strong>Link:</strong> https://rezeros.github.io/2020/10/01/csapp/</li><li><strong>License: </strong>This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.</li></ul></div></div><ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden"><li class="tag-item mx-0.5"><a href="/tags/Program/">#Program</a>&nbsp;</li><li class="tag-item mx-0.5"><a href="/tags/OS/">#OS</a>&nbsp;</li></ul><div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8"><div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2"><a class="prev" rel="prev" href="/2020/12/13/elastic-search/"><span class="left arrow-icon flex justify-center items-center"><i class="fa-solid fa-chevron-left"></i> </span><span class="title flex justify-center items-center"><span class="post-nav-title-item">elastic-search 笔记</span> <span class="post-nav-item">Prev posts</span></span></a></div><div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2"><a class="next" rel="next" href="/2020/09/26/oql/"><span class="title flex justify-center items-center"><span class="post-nav-title-item">OQL</span> <span class="post-nav-item">Next posts</span> </span><span class="right arrow-icon flex justify-center items-center"><i class="fa-solid fa-chevron-right"></i></span></a></div></div><div class="comment-container px-2 sm:px-6 md:px-8 pb-8"><div class="comments-container mt-10 w-full"><div id="comment-anchor" class="w-full h-2.5"></div><div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">Comments</div><div id="giscus-container"></div><script data-swup-reload-script defer>async function loadGiscus(){const t={src:"https://giscus.app/client.js","data-repo":"rezeros/rezeros.github.io","data-repo-id":"MDEwOlJlcG9zaXRvcnkxNjk3MzU3NzA=","data-category":"Announcements","data-category-id":"DIC_kwDOCh32Ws4Co2GO","data-mapping":"pathname","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"1","data-theme":"preferred_color_scheme","data-lang":"en","data-input-position":"bottom","data-loading":"not-lazy",crossorigin:"anonymous",async:!0},a=document.createElement("script");for(const e in t)a.setAttribute(e,t[e]);document.getElementById("giscus-container").appendChild(a)}{let t=setTimeout(()=>{loadGiscus(),clearTimeout(t)},1e3)}</script></div></div></div><div class="toc-content-container"><div class="post-toc-wrap"><div class="post-toc"><div class="toc-title">On this page</div><div class="page-title">CSAPP</div><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Not-be-the-real-thing"><span class="nav-text">Not be the real thing</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Memory"><span class="nav-text">Memory</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Bit"><span class="nav-text">Bit</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Integer"><span class="nav-text">Integer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Type-Conversion"><span class="nav-text">Type Conversion</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Conversion-mutual"><span class="nav-text">Conversion mutual</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Type-extension-amp-Intercept"><span class="nav-text">Type extension &amp; Intercept</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Calculate-amp-Overflow"><span class="nav-text">Calculate &amp; Overflow</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Float"><span class="nav-text">Float</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#IEEE-standard"><span class="nav-text">IEEE standard</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Data-in-Memory"><span class="nav-text">Data in Memory</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Basic"><span class="nav-text">Basic</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#C2M"><span class="nav-text">C2M</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Assembly"><span class="nav-text">Assembly</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Flow-Control"><span class="nav-text">Flow Control</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Condition-amp-Jump"><span class="nav-text">Condition &amp; Jump</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Process-call"><span class="nav-text">Process call</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Stack-Structure"><span class="nav-text">Stack Structure</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Call-ways"><span class="nav-text">Call ways</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Data-Storage"><span class="nav-text">Data Storage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cache-overflow"><span class="nav-text">Cache overflow</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Optimize"><span class="nav-text">Optimize</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Base-concept"><span class="nav-text">Base concept</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Memory-Hierarchy"><span class="nav-text">Memory Hierarchy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cache-Memory"><span class="nav-text">Cache Memory</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Read"><span class="nav-text">Read:</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Complie"><span class="nav-text">Complie</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Object-files"><span class="nav-text">Object files</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Object-format"><span class="nav-text">Object format</span></a></li></ol></li></ol></div></div></div></div></div></div><div class="main-content-footer"><footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color"><div class="info-container py-3 text-center"><div class="text-center">&copy; <span>2022</span> - 2025&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration:0.5s;color:#f54545"></i>&nbsp;&nbsp;<a href="/">ReZero</a><p class="post-count space-x-0.5"><span>60 posts in total</span></p></div><script data-swup-reload-script src="https://cn.vercount.one/js"></script><div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right"><span id="busuanzi_container_site_uv" class="lg:!block"><span class="text-sm">VISITOR COUNT</span> <span id="busuanzi_value_site_uv"></span> </span><span id="busuanzi_container_site_pv" class="lg:!block"><span class="text-sm">TOTAL PAGE VIEWS</span> <span id="busuanzi_value_site_pv"></span></span></div><div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left"><span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span> <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.8.2</a></span></div><div>Blog up for <span class="odometer" id="runtime_days"></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec</div><script data-swup-reload-script>try{function odometer_init(){document.querySelectorAll(".odometer").forEach(e=>{new Odometer({el:e,format:"( ddd).dd",duration:200})})}odometer_init()}catch(e){}</script></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="article-tools-list"><li class="right-bottom-tools page-aside-toggle"><i class="fa-regular fa-outdent"></i></li><li class="go-comment"><i class="fa-regular fa-comments"></i></li></ul></div></div><div class="right-side-tools-container"><div class="side-tools-container"><ul class="hidden-tools-list"><li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center"><i class="fa-regular fa-magnifying-glass-plus"></i></li><li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center"><i class="fa-regular fa-magnifying-glass-minus"></i></li><li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center"><i class="fa-regular fa-moon"></i></li><li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center"><i class="fa-regular fa-arrow-down"></i></li></ul><ul class="visible-tools-list"><li class="right-bottom-tools toggle-tools-list flex justify-center items-center"><i class="fa-regular fa-cog fa-spin"></i></li><li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><div class="image-viewer-container"><img src=""></div></main><script src="/js/build/libs/Swup.min.js"></script><script src="/js/build/libs/SwupSlideTheme.min.js"></script><script src="/js/build/libs/SwupScriptsPlugin.min.js"></script><script src="/js/build/libs/SwupProgressPlugin.min.js"></script><script src="/js/build/libs/SwupScrollPlugin.min.js"></script><script src="/js/build/libs/SwupPreloadPlugin.min.js"></script><script>const swup=new Swup({plugins:[new SwupScriptsPlugin({optin:!0}),new SwupProgressPlugin,new SwupScrollPlugin({offset:80}),new SwupSlideTheme({mainElement:".main-content-body"}),new SwupPreloadPlugin],containers:["#swup"]})</script><script src="/js/build/tools/imageViewer.js" type="module"></script><script src="/js/build/utils.js" type="module"></script><script src="/js/build/main.js" type="module"></script><script src="/js/build/layouts/navbarShrink.js" type="module"></script><script src="/js/build/tools/scrollTopBottom.js" type="module"></script><script src="/js/build/tools/lightDarkSwitch.js" type="module"></script><script src="/js/build/layouts/categoryList.js" type="module"></script><script src="/js/build/tools/codeBlock.js" type="module"></script><script src="/js/build/layouts/lazyload.js" type="module"></script><script src="/js/build/tools/runtime.js"></script><script src="/js/build/libs/odometer.min.js"></script><link rel="stylesheet" href="/assets/odometer-theme-minimal.css"><script src="/js/build/libs/Typed.min.js"></script><script src="/js/build/plugins/typed.js" type="module"></script><script src="/js/build/tools/tocToggle.js" type="module" data-swup-reload-script=""></script><script src="/js/build/layouts/toc.js" type="module" data-swup-reload-script=""></script><script src="/js/build/plugins/tabs.js" type="module" data-swup-reload-script=""></script><script src="/js/build/libs/moment-with-locales.min.js" data-swup-reload-script=""></script><script src="/js/build/layouts/essays.js" type="module" data-swup-reload-script=""></script></body></html>